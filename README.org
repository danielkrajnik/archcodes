#+title: Archcodes

* Overview
* Deployment
** Hosting
If you choose to host "on the cloud ☁️" here are my recommmendations for privacy-oriented providers.
[2023-10-19 Thu]
| name         | Location       | Price                        |
|--------------+----------------+------------------------------|
| 1984.hosting | Iceland        | 77 € / year (27.49 € for 1st year) |
| njal.la      | Sweden (Malmo) | 15 € / month                 |
| exoscale.com | Europe         | 11.93 € / month              |
[[https://www.reddit.com/r/privacy/comments/oe3yef/comment/h448xls/?utm_source=share&utm_medium=web2x&context=3][Other recommendations]]
** Base setup
*** Preliminaries
- Debian 12
- first login with public ssh key shared with the hosting provider
- first login as root
- ownership of a DNS domain
*** Update and upgrade packages
#+begin_src sh
sudo apt update && sudo apt upgrade -y
#+end_src
*** Add new sudo user
#+begin_src sh
adduser admin --gecos ""
usermod -aG sudo admin
#+end_src
*** Transfer ssh key
#+begin_src sh
cp -r /root/.ssh /home/admin
chown -R admin:admin /home/admin/.ssh
#+end_src
Logout of =root= and login as =admin=.
*** Remove message on login
#+begin_src sh
touch .hushlogin
#+end_src
*** Remove root password and lock
#+begin_src sh
sudo passwd -d root
sudo passwd -l root
#+end_src
*** Configure firewall
On Debian ufw may be already installed and preconfigured.
#+begin_src sh
sudo apt install ufw -y
sudo ufw allow <CHOOSE-PORT-NUMBER-BETWEEN-1024-AND-65535>
# For example: sudo ufw allow 38461
sudo ufw enable
#+end_src
*** Configure ssh daemon
#+begin_src sh
sudo vi /etc/ssh/sshd_config
#+end_src
#+begin_src conf
Port <CHOOSE-PORT-BETWEEN-1024-AND-65535>
# For example: Port 38461

# Disable login as root 
PermitRootLogin no
# No need for Graphics on a server
X11Forwarding no
# Use cryptographic keys instead of passwords 
PasswordAuthentication no
# Only allow "admin" user to login via ssh 
# If you named your user differently change it for that name
AllowUsers admin
#+end_src
#+begin_src sh
sudo systemctl restart sshd
#+end_src
⚠️ [[#Deployments][Note down]] the Port number.
⚠️ Before logging out make sure port number [[*Configure firewall][was allowed in ufw]] or you will be locked out.
*** Miscellaneous fixes
**** Disable passwordless sudo
#+begin_src sh
# Check if this file exists
sudo cat /etc/sudoers.d/90-cloud-init-users
# Remove it
sudo rm /etc/sudoers.d/90-cloud-init-users
#+end_src
**** Disable ssh logins via password
#+begin_src sh
# Check if this file exists
sudo cat /etc/ssh/sshd_config.d/50-cloud-init.conf
# Remove it
sudo rm /etc/ssh/sshd_config.d/50-cloud-init.conf
# Restart ssh
sudo systemctl restart sshd
#+end_src
*** Configure fail2ban
Your server will be constantly scanned for vulnerabilities by various (good and bad) parties. Fail2Ban blocks such attempts if they reach a predefined number of unsuccessful connections.
#+begin_src sh
sudo apt install fail2ban -y
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo vi /etc/fail2ban/jail.local
#+end_src
Sane defaults:
#+begin_src conf
[DEFAULT]
bantime = 1000m
findtime = 100m
maxentry = 3
# In Debian 12 it became necessary to specify systemd backend explicitely.
backend = systemd
#+end_src
⚠ If you failed to connect more than 3 times before setting this up it may block you. [[*Unban your IP][Fix]]
#+begin_src sh
sudo systemctl restart fail2ban.service
#+end_src
**** Unban your IP
⚠ Advanced
Use a proxy/VPN/Tor to change your IP, reconnect to the server and unban you IP.
***** Tor
Start tor service or connect the Tor Browser.
The easiest way to setup Tor service on desktop is to download the [[https://www.torproject.org/download/][Tor Browser]] and start it. It bundles tor server and will make it available locally on port 9050.
#+begin_src sh
ssh -o ProxyCommand='nc -x 127.0.0.1:9150 %h %p' <USER>@<SERVER-IP>
# check your IP
curl ifconfig.me
#+end_src
[[*unban IP][Unban]] your original IP: ~fail2ban-client set sshd unbanip <YOUR-ORIGNAL-IP>~
*** Optional
**** Copy .bashrc
Recommended =.bashrc= included in this repo.
#+begin_src sh
scp -P <SSH-PORT-NUMBER> <PATH-TO-THIS-REPO>/.bashrc <SERVER-IP>:
#+end_src
**** fzf
Install fzf fuzzy finder to serach command history interactively (Ctrl+R).
#+begin_src sh
sudo apt install git wget -y
git clone --depth 1 https://github.com/junegunn/fzf.git .fzf
./.fzf/install
#+end_src
**** Extras
#+begin_src sh
sudo apt install fd-find exa bat ripgrep htop nethogs -y
#+end_src
Below aliases (e.g. ~b~ instead of ~batcat~) were set in the above [[*Copy .bashrc][.bashrc file]].
***** fd-find
Search files by name.
****** Example
Find all directories (~-td~) that have ~system-wg~ somewhere in their name. Search only in ~/sys/fs/cgroup~.
#+begin_src sh
fd -td system-wg /sys/fs/cgroup
#+end_src
***** ripgrep
Search files by =contents= name.
****** Example
Search for ~alias~ in ~.bashrc~
#+begin_src sh
rg alias .bashrc
#+end_src
***** exa
Pretty print directories.
****** Example
#+attr_org: :width 300px
[[file:README-images/_20231019_161012screenshot.png]]
***** bat
View file contents.
****** Example
View contents of ~.bashrc~.
#+begin_src sh
b .bashrc
#+end_src
***** htop
View running processes.
****** Example
#+begin_src sh
htop
#+end_src
***** nethogs
View running network connections.
****** Example
#+begin_src sh
nethogs -l -a -C
#+end_src
~-l~     display command line
~-C~     capture TCP and UDP
~-a~     monitor all devices, even loopback/stopped ones
*** Dns and hostname
These may have been automatically set by your hosting provider.
**** Your hostname
#+begin_src sh
cat /etc/hostname
#+end_src
**** Server DNS
#+begin_src sh
sudo vi /etc/host
#+end_src
127.0.1.1 hostname.example.com hostname
or:
<STATIC-IP> hostname.example.com hostname
**** Test
#+begin_src sh
dnsdomainname
dnsdomainname -f
dnsdomainname --fqdn
#+end_src
*** Reboot
#+begin_src sh
sudo reboot
#+end_src
** Maintenance
*** Fail2ban
**** list banned IPs
#+begin_src sh
sudo fail2ban-client status sshd
sudo zgrep 'Ban' /var/log/fail2ban.log* | b
#+end_src
**** unban IP
#+begin_src sh
fail2ban-client set sshd unbanip IPADDRESSHERE
#+end_src
or unban all IPs
#+begin_src sh
fail2ban-client unban --all
#+end_src
*** Check on unsolicited connections
#+begin_src sh
journalctl -u sshd
cat /var/log/fail2ban.log
#+end_src
*** Check previous logins
#+begin_src sh
last
#+end_src
*** Check for update history
#+begin_src sh
zgrep . /var/log/apt/history.log*
#+end_src
*** Check uptime
#+begin_src sh
uptime
#+end_src
*** Check kernel release
#+begin_src sh
uname --kernel-release
#+end_src
*** Full ditro upgrade
Make sure to take snapshot/backup beforehand. It's not always guaranteed to work.
#+begin_src sh
sudo apt-get full-upgrade
#+end_src
